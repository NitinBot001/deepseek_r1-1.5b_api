name: Run OLLAMA Server with Auto Restart

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Fixed cron: Every 6 hours

jobs:
  run-ollama-server:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install OLLAMA
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          echo "OLLAMA installed successfully!"
          sudo ufw allow 11434/tcp
          sudo ufw allow 80
          sudo ufw allow 443

      - name: Kill Any Existing Ollama Process 
        run: | 
          if pgrep -x "ollama" > /dev/null; then 
            echo "Ollama is already running. Stopping it..." 
            sudo pkill -9 ollama || true  # Force kill if needed, ignore errors 
            sleep 5 
          fi 
 
      - name: Start Ollama 
        run: | 
          echo "Starting Ollama..." 
          nohup ollama serve > ollama.log 2>&1 &  # Run Ollama in the background 
          sleep 10 
 
      - name: Pull DeepSeek Model 
        run: | 
          echo "Downloading deepseek-r1:1.5b model..." 
          ollama pull llama3.2 & 
          sleep 10 
          
      - name: Start Tunnel and Restart Every 55 Minutes
        run: |
          while true; do
            echo "Starting new Pinggy tunnel..."
            sudo apt install nodejs 
            sudo npx nport -s ollamazjhfh -p 11434 
            echo "Waiting 55 minutes before restarting..."
            sleep 21300
            
          done
